#!/usr/bin/env bash

__DIRNAME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
__PWD="$(pwd)"
NODE_ENV=production
BUILD_DIR=dist
APP_NAME=classmentors
BUILD_DEST=${BUILD_DIR}/${APP_NAME}

echo "Backing up config..."
cp src/config.js src/config.clean.js

echo "Finding all dependencies..."
jspm depcache app.js

echo "Setting up ${BUILD_DEST}..."
if [[ -d "$BUILD_DEST" ]]; then
	rm -r $BUILD_DEST
fi

mkdir -p $BUILD_DEST
cp -r ${__DIRNAME}/assets/* $BUILD_DEST

echo "Building app bundle..."
jspm bundle-sfx app.js ${BUILD_DEST}/app.js --minify

echo "Copying Ace editor assets..."
cp src/jspm_packages/github/ajaxorg/ace-builds@*/worker-html.js       ${BUILD_DEST}/worker-html.js
cp src/jspm_packages/github/ajaxorg/ace-builds@*/worker-javascript.js ${BUILD_DEST}/worker-javascript.js

echo "Creating archive..."
cd $BUILD_DIR
zip -r ${APP_NAME}.zip $APP_NAME
cd $__PWD

echo "Restoring config..."
mv src/config.clean.js src/config.js
